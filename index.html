<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VAULT">
    <meta name="theme-color" content="#020617">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #e6faff; --text: #000000; --header: #000000; --card-border: rgba(0,0,0,0.3); --glass: rgba(15, 23, 42, 0.98); --notes-btn: #0369a1; --subtext: #475569; }
        body.dark-mode { --bg: #020617; --text: #cbd5e1; --header: #ffffff; --card-border: rgba(255,255,255,0.1); --glass: rgba(0, 0, 0, 0.95); --notes-btn: #38bdf8; --subtext: #94a3b8; }
        body { background-color: var(--bg) !important; color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 1rem; min-height: 100vh; transition: background 0.3s; }
        
        .vault-logo { font-size: 2.5rem; font-weight: 1000; color: var(--header) !important; font-style: italic; letter-spacing: -0.07em; line-height: 1; text-transform: uppercase; cursor: pointer; user-select: none; }
        .archive-text { color: var(--subtext) !important; font-size: 10px; font-weight: 1000; text-transform: uppercase; letter-spacing: 0.25em; }
        h2 { color: var(--header) !important; font-weight: 950 !important; text-transform: uppercase; letter-spacing: 0.15em; font-size: 1.1rem !important; margin: 0; }
        
        .icon-btn { color: var(--header) !important; transition: transform 0.2s; }
        .icon-btn:active { transform: scale(0.9); }

        .media-card { position: relative; border: 1px solid var(--card-border); backdrop-filter: blur(20px); border-radius: 12px; overflow: hidden; margin-bottom: 0.75rem; box-shadow: 0 6px 15px rgba(0,0,0,0.25); z-index: 10; }
        .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 40; }
        
        .priority-bg-1 { background: linear-gradient(135deg, #b91c1c 0%, #0f172a 100%); }
        .priority-bg-2 { background: linear-gradient(135deg, #b45309 0%, #0f172a 100%); }
        .priority-bg-3 { background: linear-gradient(135deg, #1d4ed8 0%, #0f172a 100%); }
        .priority-bg-4 { background: #0f172a; }
        .priority-bg-done { background: #1e293b; opacity: 0.8; }

        .card-vidya { border-left: 6px solid #fbbf24; } .card-movie { border-left: 6px solid #ef4444; } .card-tv { border-left: 6px solid #10b981; }
        .category-watermark { position: absolute; top: -5px; right: 40px; font-size: 1.8rem; font-weight: 950; opacity: 0.15; pointer-events: none; font-style: italic; text-transform: uppercase; z-index: 0; color: white; }
        
        #live-results { position: absolute; top: 100%; left: 0; right: 0; background: #020617; border: 2px solid #3b82f6; border-top: none; border-radius: 0 0 12px 12px; z-index: 1000; max-height: 350px; overflow-y: auto; display: none; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
        #live-results.active { display: block; }
        .live-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; color: white; display: flex; align-items: center; gap: 12px; }
        .live-item:hover { background: #1e293b; }
        .live-img { width: 40px; height: 55px; object-fit: cover; border-radius: 4px; background: #334155; flex-shrink: 0; }

        .thin-search { background: transparent; border: none; border-bottom: 3px solid var(--header); width: 100%; font-size: 14px; padding: 10px 0; outline: none; color: var(--header); font-weight: 950; margin-bottom: 1.5rem; }
        .thin-search::placeholder { color: var(--header); opacity: 0.7; }
        
        #settings-menu { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        #settings-menu.active { display: flex; }
        
        .pri-dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.2s; }
    </style>
</head>
<body id="body-root">
    <div class="max-w-3xl mx-auto pb-32">
        <header class="mb-6 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="sync-icon" onclick="pullFromCloud()" class="icon-btn cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path><polyline points="22 4 22 10 16 10"></polyline></svg>
                </div>
                <div>
                    <h1 class="vault-logo" onclick="toggleTheme()">VAULT</h1>
                    <p class="archive-text">Archive 2026</p>
                </div>
            </div>
            <button onclick="document.getElementById('settings-menu').classList.toggle('active')" class="icon-btn p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <input id="global-search" type="text" class="thin-search" placeholder="FILTER VAULT..." oninput="render()">

        <div class="glass p-5 rounded-3xl mb-10 shadow-2xl">
            <div class="grid grid-cols-1 gap-4">
                <div class="relative z-[60]">
                    <input id="title" type="text" autocomplete="off" placeholder="Enter Title..." oninput="debounceSearch()" class="bg-black/60 border border-white/20 p-4 rounded-xl text-white w-full outline-none placeholder-white/60 font-bold">
                    <div id="live-results"></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <select id="category" class="bg-slate-900 p-3 rounded-xl text-[10px] text-white font-black uppercase outline-none border border-white/10">
                        <option value="movie">ðŸŽ¥ Movie</option><option value="tv">ðŸ“º TV Show</option><option value="vidya" selected>ðŸŽ® Game</option>
                    </select>
                    <select id="priority" class="bg-slate-900 p-3 rounded-xl text-[10px] text-white font-black uppercase outline-none border border-white/10">
                        <option value="1">Immediate</option><option value="2">High</option><option value="3" selected>Medium</option><option value="4">Low</option>
                    </select>
                    <select id="sort-order" onchange="localStorage.setItem('vault_sort', this.value); render();" class="bg-blue-900 p-3 rounded-xl text-[10px] text-white font-black uppercase outline-none border border-white/10">
                        <option value="priority">Sort: Pri</option><option value="recent">Sort: New</option><option value="rating">Sort: Sc</option><option value="release">Sort: Yr</option><option value="manual">Sort: Man</option>
                    </select>
                </div>
                <button onclick="finalizeAdd(document.getElementById('title').value, '2026', 0, 'Custom', '--')" class="bg-blue-600 text-white py-3 rounded-xl font-black text-xs uppercase shadow-lg active:scale-95 border-b-4 border-blue-800">Add</button>
                <div id="status-log" class="text-white text-[10px] text-center font-bold uppercase mt-2">Ready</div>
            </div>
        </div>
        <div id="tables-container" class="space-y-8"></div>
    </div>

    <div id="settings-menu">
        <div class="bg-slate-900 w-11/12 max-sm p-6 rounded-2xl border border-white/10 shadow-2xl">
            <h3 class="text-white font-black uppercase text-xl mb-6 text-center">Settings</h3>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="showArchive=!showArchive; render();" class="bg-amber-600 text-white p-4 rounded-xl text-[10px] font-black uppercase border border-white/5">Toggle Archive</button>
                <button onclick="toggleTheme()" class="bg-slate-800 text-white p-4 rounded-xl text-[10px] font-black uppercase border border-white/5">Night Mode</button>
                <button onclick="setupCloud()" class="bg-slate-800 text-white p-4 rounded-xl text-[10px] font-black uppercase border border-white/5">Cloud</button>
                <button onclick="downloadBackup()" class="bg-slate-800 text-white p-4 rounded-xl text-[10px] font-black uppercase border border-white/5">Export</button>
                <button onclick="document.getElementById('importFile').click()" class="bg-slate-800 text-white p-4 rounded-xl text-[10px] font-black uppercase border border-white/5">Import</button>
            </div>
            <button onclick="document.getElementById('settings-menu').classList.remove('active')" class="w-full bg-white text-black p-4 rounded-xl font-black text-xs uppercase shadow-xl">Close</button>
        </div>
    </div>
    <input type="file" id="importFile" class="hidden" onchange="importBackup(this)">

    <script>
        // --- API CONFIGURATION ---
        const TMDB_KEY = "f8baa5b950fb92e47e7250e9faaa2a5c";
        const CLIENT_ID = "8bjq7bqv85pvclvbdlo4ocgff060tp";
        const CLIENT_SECRET = "96q58dkxsz3cfe853ckpn9opqy6sli"; // <--- UPDATE THIS
        // -------------------------

        let items = JSON.parse(localStorage.getItem('media_v1')) || [], collapsed = JSON.parse(localStorage.getItem('vault_collapsed')) || {}, cloudConfig = JSON.parse(localStorage.getItem('vault_cloud')) || { token: '', gistId: '' }, searchTimeout, showArchive = false;
        if(localStorage.getItem('vault_dark') === 'true') document.body.classList.add('dark-mode');

        async function save() { localStorage.setItem('media_v1', JSON.stringify(items)); render(); if (cloudConfig.token && cloudConfig.gistId) { try { await fetch(`https://api.github.com/gists/${cloudConfig.gistId}`, { method: "PATCH", headers: { "Authorization": `token ${cloudConfig.token}` }, body: JSON.stringify({ files: { "vault.json": { content: JSON.stringify(items) } } }) }); } catch(e) { console.error("Cloud Save Failed"); } } }
        async function pullFromCloud() { if (!cloudConfig.token || !cloudConfig.gistId) return; try { const res = await fetch(`https://api.github.com/gists/${cloudConfig.gistId}`, { headers: { "Authorization": `token ${cloudConfig.token}` } }); const data = await res.json(); if (data.files?.["vault.json"]) { items = JSON.parse(data.files["vault.json"].content); render(); } } catch(e) { console.error("Cloud Pull Failed"); } }

        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('vault_dark', document.body.classList.contains('dark-mode')); render(); }

        async function refreshIGDBToken() { 
            try { 
                // Using AllOrigins Proxy for more reliability in 2026
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://id.twitch.tv/oauth2/token?client_id='+CLIENT_ID+'&client_secret='+CLIENT_SECRET+'&grant_type=client_credentials')}`);
                const wrapper = await res.json();
                const d = JSON.parse(wrapper.contents);
                if (d.access_token) { localStorage.setItem('igdb_token', d.access_token); return d.access_token; }
                return null;
            } catch(e) { return null; } 
        }

        function debounceSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(performLiveSearch, 400); }

        async function performLiveSearch() {
            const title = document.getElementById('title').value.trim(), cat = document.getElementById('category').value, dropdown = document.getElementById('live-results');
            if (title.length < 2) { dropdown.classList.remove('active'); return; }
            dropdown.innerHTML = '<div class="p-3 text-xs text-white/50 italic">Searching...</div>'; dropdown.classList.add('active');
            
            try {
                let results = [];
                if (cat === 'vidya') {
                    let token = localStorage.getItem('igdb_token') || await refreshIGDBToken();
                    const igdbUrl = 'https://api.igdb.com/v4/games';
                    const igdbBody = `fields name, first_release_date, cover.url; search "${title}"; limit 20;`;
                    
                    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(igdbUrl)}`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }, // Bypass some blocks
                        body: JSON.stringify({ 
                            headers: { 'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${token}` },
                            method: 'POST',
                            body: igdbBody
                        })
                    });
                    
                    const wrapper = await res.json();
                    const d = JSON.parse(wrapper.contents);
                    
                    if(d && Array.isArray(d)) {
                        results = d.map(g => ({ title: g.name, year: g.first_release_date ? new Date(g.first_release_date*1000).getFullYear() : 'TBA', id: g.id, img: g.cover ? g.cover.url.replace('t_thumb', 't_cover_small') : '' }));
                    } else { throw new Error("Search Error"); }
                } else {
                    const r = await fetch(`https://api.themoviedb.org/3/search/${cat}?api_key=${TMDB_KEY}&query=${encodeURIComponent(title)}`);
                    const d = await r.json(); if(d.results) results = d.results.map(m => ({ title: m.title || m.name, year: (m.release_date || m.first_air_date || 'TBA').split('-')[0], id: m.id, img: m.poster_path ? `https://image.tmdb.org/t/p/w92${m.poster_path}` : '' }));
                }
                
                dropdown.innerHTML = `<div onclick="finalizeAdd('${title.replace(/'/g, "\\'")}', '2026', 0, 'Custom', '--')" class="live-item text-blue-400 italic text-xs font-black">USE RAW: "${title}"</div>`;
                results.forEach(res => {
                    const el = document.createElement('div'); el.className = 'live-item';
                    el.innerHTML = `<img src="${res.img || ''}" class="live-img"><div><div class="font-bold text-sm">${res.title}</div><div class="text-[10px] opacity-50">${res.year}</div></div>`;
                    el.onclick = () => processSelection(cat, res.id, res.title);
                    dropdown.appendChild(el);
                });
            } catch(e) { dropdown.innerHTML = '<div class="p-3 text-xs text-red-400">Search Error</div>'; }
        }

        async function processSelection(cat, id, title) {
            document.getElementById('live-results').classList.remove('active');
            try {
                let score=0, year='2026', genre='Genre', runtime='--';
                if(cat === 'vidya') {
                    let token = localStorage.getItem('igdb_token') || await refreshIGDBToken();
                    const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://api.igdb.com/v4/games')}`, {
                        method: 'POST',
                        body: JSON.stringify({
                            headers: { 'Client-ID': CLIENT_ID, 'Authorization': `Bearer ${token}` },
                            method: 'POST',
                            body: `fields name, total_rating, first_release_date, genres.name; where id = ${id};`
                        })
                    });
                    const wrap = await r.json(); const d = JSON.parse(wrap.contents);
                    if(d[0]) { score = d[0].total_rating ? Math.round(d[0].total_rating) : 0; year = d[0].first_release_date ? new Date(d[0].first_release_date * 1000).getFullYear() : "2026"; genre = d[0].genres?.[0]?.name || "Game"; }
                } else {
                    const det = await (await fetch(`https://api.themoviedb.org/3/${cat}/${id}?api_key=${TMDB_KEY}`)).json();
                    score = Math.round(det.vote_average * 10); year = (det.release_date || det.first_air_date || "").split('-')[0]; genre = det.genres?.[0]?.name || cat.toUpperCase();
                    if(cat === 'movie') runtime = det.runtime ? det.runtime + 'm' : '--'; else runtime = (det.number_of_seasons ? 'S'+det.number_of_seasons : 'S1') + ' E' + (det.number_of_episodes || '--');
                }
                finalizeAdd(title, year, score, genre, runtime);
            } catch(e) { alert("Error adding item."); }
        }

        function finalizeAdd(title, year, score, genre, runtime) { const newItem = { id: Date.now(), title, category: document.getElementById('category').value, priority: parseInt(document.getElementById('priority').value), status: 'to-do', score, genre, release: year, runtime, notes: '' }; items.push(newItem); document.getElementById('title').value = ''; document.getElementById('live-results').classList.remove('active'); save(); }
        function downloadBackup() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(items, null, 2)); a.download = "vault_backup.json"; a.click(); }
        function importBackup(i) { const r = new FileReader(); r.onload = e => { items = JSON.parse(e.target.result); save(); }; r.readAsText(i.files[0]); }
        async function setupCloud() { const gt = prompt("Token:", cloudConfig.token), gi = prompt("Gist ID:", cloudConfig.gistId); if (gt && gi) { cloudConfig = { token: gt, gistId: gi }; localStorage.setItem('vault_cloud', JSON.stringify(cloudConfig)); await pullFromCloud(); } }
        
        function render() {
            const container = document.getElementById('tables-container'), s = localStorage.getItem('vault_sort') || 'priority', filter = document.getElementById('global-search').value.toLowerCase(), cats = { vidya: 'ðŸŽ® GAMES', movie: 'ðŸŽ¥ CINEMA', tv: 'ðŸ“º SERIES' };
            container.innerHTML = '';
            ['vidya', 'movie', 'tv'].forEach(key => {
                let list = items.filter(i => i.category === key && i.title.toLowerCase().includes(filter));
                list = showArchive ? list.filter(i => i.status === 'done') : list.filter(i => i.status !== 'done');
                if (list.length === 0 && !filter) return;
                let section = `<section><h2 class="mt-6 mb-2 cursor-pointer" onclick="collapsed['${key}']=!collapsed['${key}']; save();">${cats[key]} ${collapsed[key]?'âŠ•':''}</h2><div style="display:${collapsed[key]?'none':'block'}" class="space-y-2">`;
                list.forEach(i => {
                    section += `<div class="media-card card-${key} priority-bg-${i.priority} p-3"><h3 class="font-black text-white text-sm">${i.title}</h3><div class="flex gap-2 mt-2"><select onchange="items.find(x=>x.id===${i.id}).status=this.value; save();" class="text-[9px] font-black uppercase bg-black/60 text-white p-1 rounded"><option value="to-do" ${i.status==='to-do'?'selected':''}>To-Do</option><option value="done">Done</option></select><button onclick="items=items.filter(z=>z.id!==${i.id}); save();" class="text-white text-[9px] font-black bg-white/10 px-2 rounded">DEL</button></div></div>`;
                });
                container.innerHTML += section + `</div></section>`;
            });
        }
        render(); pullFromCloud();
    </script>
</body>
</html>
